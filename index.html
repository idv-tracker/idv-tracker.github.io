<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¬¬äº”äººæ ¼ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6919699894432312"
     crossorigin="anonymous"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
      color: white;
      padding: 25px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 32px;
      margin-bottom: 5px;
      font-weight: 700;
    }
    
    .header .subtitle {
      font-size: 14px;
      opacity: 0.9;
      font-weight: 400;
    }
    
    .perspective-tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .perspective-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      background: #f8f9fa;
      border: none;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .perspective-tab.active {
      background: white;
      color: #0f3460;
      border-bottom: 3px solid #0f3460;
    }
    
    .perspective-tab:hover {
      background: #e9ecef;
    }
    
    .main-tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      overflow-x: auto;
    }
    
    .main-tab {
      padding: 12px 20px;
      cursor: pointer;
      background: #f8f9fa;
      border: none;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.3s;
    }
    
    .main-tab.active {
      background: white;
      color: #0f3460;
      border-bottom: 2px solid #0f3460;
    }
    
    .main-tab:hover {
      background: #e9ecef;
    }
    
    .content {
      padding: 25px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    
    select:focus {
      outline: none;
      border-color: #0f3460;
    }
    
    .result-buttons {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    
    .result-button {
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .result-button:hover {
      border-color: #0f3460;
      background: #e6f0ff;
    }
    
    .result-button.selected {
      background: #0f3460;
      color: white;
      border-color: #0f3460;
    }
    
    .submit-button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #0f3460 0%, #533483 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: transform 0.2s;
    }
    
    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(15, 52, 96, 0.4);
    }
    
    .submit-button:active {
      transform: translateY(0);
    }
    
    .filter-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .stats-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .stats-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
    }
    
    .overall-stats-display {
      background: white;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
    }
    
    .winrate-big {
      font-size: 48px;
      font-weight: 700;
      color: #0f3460;
      margin-bottom: 10px;
    }
    
    .record-text {
      font-size: 18px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .streak-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 10px;
    }
    
    .streak-icon {
      font-size: 20px;
    }
    
    /* æ¨ªæ£’ã‚°ãƒ©ãƒ•ã‚¹ã‚¿ã‚¤ãƒ« */
    .bar-chart-horizontal {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 20px;
      background: white;
      border-radius: 8px;
    }
    
    .bar-row {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      min-height: 45px;
    }
    
    .bar-label-wrapper {
      min-width: 110px;
      max-width: 110px;
      flex-shrink: 0;
    }
    
    .bar-label {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      word-wrap: break-word;
      margin-bottom: 3px;
    }
    
    .bar-sublabel {
      font-size: 10px;
      color: #999;
      line-height: 1.3;
    }
    
    .bar-wrapper {
      flex: 1;
      min-width: 0;
      height: 28px;
      background: #f0f0f0;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
    }
    
    .bar-visual {
      height: 100%;
      background: linear-gradient(90deg, #60a5fa, #3b82f6);
      border-radius: 4px;
      transition: width 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
    }
    
    .bar-value {
      color: white;
      font-size: 11px;
      font-weight: 700;
      white-space: nowrap;
    }
    
    .bar-value-zero {
      position: static;
      transform: none;
      color: #999;
      background: transparent;
      font-size: 11px;
      font-weight: 600;
      padding-left: 10px;
    }
    
    .match-history {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .match-item {
      padding: 15px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .match-item:last-child {
      border-bottom: none;
    }
    
    .match-info {
      flex: 1;
    }
    
    .match-result {
      padding: 5px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 10px;
    }
    
    .match-result.win {
      background: #d4edda;
      color: #155724;
    }
    
    .match-result.lose {
      background: #f8d7da;
      color: #721c24;
    }
    
    .match-result.draw {
      background: #fff3cd;
      color: #856404;
    }
    
    .match-actions button {
      margin-left: 5px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .edit-button {
      background: #ffc107;
      color: #000;
    }
    
    .delete-button {
      background: #dc3545;
      color: white;
    }
    
    .reset-button {
      background: #dc3545;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 20px;
    }
    
    .reset-button:hover {
      background: #c82333;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ç¬¬äº”äººæ ¼ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
      <div class="subtitle">æˆ¦ç¸¾ç®¡ç†ãƒ»å‹ç‡è¨ˆç®—</div>
    </div>
    
    <div class="perspective-tabs">
      <button class="perspective-tab active" onclick="switchPerspective('survivor')">ã‚µãƒã‚¤ãƒãƒ¼</button>
      <button class="perspective-tab" onclick="switchPerspective('hunter')">ãƒãƒ³ã‚¿ãƒ¼</button>
    </div>
    
    <div class="main-tabs">
      <button class="main-tab active" onclick="switchTab('input')">è©¦åˆå…¥åŠ›</button>
      <button class="main-tab" onclick="switchTab('character')">è‡ªã‚­ãƒ£ãƒ©åˆ¥å‹ç‡</button>
      <button class="main-tab" onclick="switchTab('map')">ãƒãƒƒãƒ—åˆ¥å‹ç‡</button>
      <button class="main-tab" onclick="switchTab('opponent')">å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡</button>
      <button class="main-tab" onclick="switchTab('history')">è©¦åˆå±¥æ­´</button>
    </div>
    
    <div class="content">
      <!-- è©¦åˆå…¥åŠ›ã‚¿ãƒ– -->
      <div id="input-tab" class="tab-content active">
        <div id="overall-stats-inline"></div>
        
        <div id="survivor-input">
          <div class="form-group">
            <label class="form-label">æ®µä½</label>
            <select id="survivor-rank">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">è‡ªåˆ†ã®ã‚µãƒã‚¤ãƒãƒ¼</label>
            <select id="my-survivor" onchange="updateSurvivorSelects()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">å‘³æ–¹ã‚µãƒã‚¤ãƒãƒ¼1</label>
            <select id="teammate-1" onchange="updateSurvivorSelects()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">å‘³æ–¹ã‚µãƒã‚¤ãƒãƒ¼2</label>
            <select id="teammate-2" onchange="updateSurvivorSelects()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">å‘³æ–¹ã‚µãƒã‚¤ãƒãƒ¼3</label>
            <select id="teammate-3" onchange="updateSurvivorSelects()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">ç›¸æ‰‹ãƒãƒ³ã‚¿ãƒ¼</label>
            <select id="opponent-hunter">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">ãƒãƒƒãƒ—</label>
            <select id="survivor-map">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">è„±å‡ºäººæ•°</label>
            <div class="result-buttons">
              <button class="result-button" onclick="selectEscapeCount('survivor', 0)">0äºº</button>
              <button class="result-button" onclick="selectEscapeCount('survivor', 1)">1äºº</button>
              <button class="result-button" onclick="selectEscapeCount('survivor', 2)">2äºº</button>
              <button class="result-button" onclick="selectEscapeCount('survivor', 3)">3äºº</button>
              <button class="result-button" onclick="selectEscapeCount('survivor', 4)">4äºº</button>
            </div>
          </div>
          
          <button class="submit-button" onclick="submitMatch('survivor')">è©¦åˆã‚’è¨˜éŒ²</button>
        </div>
        
        <div id="hunter-input" style="display: none;">
          <div class="form-group">
            <label class="form-label">æ®µä½</label>
            <select id="hunter-rank">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">è‡ªåˆ†ã®ãƒãƒ³ã‚¿ãƒ¼</label>
            <select id="my-hunter">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">ç›¸æ‰‹ã‚µãƒã‚¤ãƒãƒ¼1</label>
            <select id="opponent-survivor-1" onchange="updateOpponentSurvivorSelects()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">ç›¸æ‰‹ã‚µãƒã‚¤ãƒãƒ¼2</label>
            <select id="opponent-survivor-2" onchange="updateOpponentSurvivorSelects()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">ç›¸æ‰‹ã‚µãƒã‚¤ãƒãƒ¼3</label>
            <select id="opponent-survivor-3" onchange="updateOpponentSurvivorSelects()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">ç›¸æ‰‹ã‚µãƒã‚¤ãƒãƒ¼4</label>
            <select id="opponent-survivor-4" onchange="updateOpponentSurvivorSelects()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">ãƒãƒƒãƒ—</label>
            <select id="hunter-map">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">è„±å‡ºäººæ•°</label>
            <div class="result-buttons">
              <button class="result-button" onclick="selectEscapeCount('hunter', 0)">0äºº</button>
              <button class="result-button" onclick="selectEscapeCount('hunter', 1)">1äºº</button>
              <button class="result-button" onclick="selectEscapeCount('hunter', 2)">2äºº</button>
              <button class="result-button" onclick="selectEscapeCount('hunter', 3)">3äºº</button>
              <button class="result-button" onclick="selectEscapeCount('hunter', 4)">4äºº</button>
            </div>
          </div>
          
          <button class="submit-button" onclick="submitMatch('hunter')">è©¦åˆã‚’è¨˜éŒ²</button>
        </div>
      </div>
      
      <!-- è‡ªã‚­ãƒ£ãƒ©åˆ¥å‹ç‡ã‚¿ãƒ– -->
      <div id="character-tab" class="tab-content">
        <div class="filter-section">
          <div class="filter-group">
            <label class="filter-label">æ®µä½ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
            <select id="character-rank-filter" onchange="updateAllStats()">
              <option value="all">å…¨æ®µä½</option>
            </select>
          </div>
        </div>
        <div id="character-stats"></div>
      </div>
      
      <!-- ãƒãƒƒãƒ—åˆ¥å‹ç‡ã‚¿ãƒ– -->
      <div id="map-tab" class="tab-content">
        <div class="filter-section">
          <div class="filter-group">
            <label class="filter-label">æ®µä½ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
            <select id="map-rank-filter" onchange="updateAllStats()">
              <option value="all">å…¨æ®µä½</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">è‡ªã‚­ãƒ£ãƒ©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
            <select id="map-char-filter" onchange="updateAllStats()">
              <option value="all">å…¨ã‚­ãƒ£ãƒ©</option>
            </select>
          </div>
        </div>
        <div id="map-stats"></div>
      </div>
      
      <!-- å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ã‚¿ãƒ– -->
      <div id="opponent-tab" class="tab-content">
        <div class="filter-section">
          <div class="filter-group">
            <label class="filter-label">æ®µä½ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
            <select id="opponent-rank-filter" onchange="updateAllStats()">
              <option value="all">å…¨æ®µä½</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">è‡ªã‚­ãƒ£ãƒ©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
            <select id="my-char-filter" onchange="onMyCharFilterChange()">
              <option value="all">å…¨ã‚­ãƒ£ãƒ©</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">ãƒãƒƒãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
            <select id="opponent-map-filter" onchange="updateAllStats()">
              <option value="all">å…¨ãƒãƒƒãƒ—</option>
            </select>
          </div>
        </div>
        <div id="opponent-stats"></div>
      </div>
      
      <!-- è©¦åˆå±¥æ­´ã‚¿ãƒ– -->
      <div id="history-tab" class="tab-content">
        <div class="filter-section">
          <div class="filter-group">
            <label class="filter-label">æ®µä½ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
            <select id="history-rank-filter" onchange="updateAllStats()">
              <option value="all">å…¨æ®µä½</option>
            </select>
          </div>
        </div>
        <div id="match-history"></div>
        <button class="reset-button" onclick="resetAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </div>

  <script>
    const SURVIVORS = ['å¹¸é‹å…', 'åŒ»å¸«', 'å¼è­·å£«', 'æ³¥æ£’', 'åº­å¸«', 'ãƒã‚¸ã‚·ãƒ£ãƒ³', 'å†’é™ºå®¶', 'å‚­å…µ', 'ç¥­å¸', 'ç©ºè»', 'æ©Ÿæ¢°æŠ€å¸«', 'ã‚ªãƒ•ã‚§ãƒ³ã‚¹', 'å¿ƒçœ¼', 'èª¿é¦™å¸«', 'ã‚«ã‚¦ãƒœãƒ¼ã‚¤', 'è¸Šã‚Šå­', 'å ã„å¸«', 'ç´æ£ºå¸«', 'æ¢é‰±è€…', 'å‘ªè¡“å¸«', 'é‡äºº', 'æ›²èŠ¸å¸«', 'ä¸€ç­‰èˆªæµ·å£«', 'ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰', 'ãƒã‚¹ãƒˆãƒãƒ³', 'å¢“å®ˆ', 'ã€Œå›šäººã€', 'æ˜†è™«å­¦è€…', 'ç”»å®¶', 'ãƒãƒƒãƒ„ãƒãƒ³', 'ç©å…·è·äºº', 'æ‚£è€…', 'ã€Œå¿ƒç†å­¦è€…ã€', 'å°èª¬å®¶', 'ã€Œå°‘å¥³ã€', 'æ³£ããƒ”ã‚¨ãƒ­', 'æ•™æˆ', 'éª¨è‘£å•†', 'ä½œæ›²å®¶', 'è¨˜è€…', 'èˆªç©ºã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', 'å¿œæ´å›£', 'äººå½¢å¸«', 'ç«ç½èª¿æŸ»å“¡', 'ã€Œãƒ¬ãƒ‡ã‚£ãƒ»ãƒ•ã‚¡ã‚¦ãƒ­ã€', 'ã€Œé¨å£«ã€', 'æ°—è±¡å­¦è€…', 'å¼“ä½¿ã„', 'ã€Œè„±å‡ºãƒã‚¹ã‚¿ãƒ¼ã€', 'å¹»ç¯å¸«', 'é—˜ç‰›å£«'];
    
    const HUNTERS = ['å¾©è®è€…', 'é“åŒ–å¸«', 'æ–­ç½ªç‹©äºº', 'ãƒªãƒƒãƒ‘ãƒ¼', 'çµé­‚è€…', 'èŠ¸è€…', 'ç™½é»’ç„¡å¸¸', 'å†™çœŸå®¶', 'ç‹‚çœ¼', 'é»„è¡£ã®ç‹', 'å¤¢ã®é­”å¥³', 'æ³£ãè™«', 'é­”ãƒˆã‚«ã‚²', 'è¡€ã®å¥³ç‹', 'ã‚¬ãƒ¼ãƒ‰No.26', 'ã€Œä½¿å¾’ã€', 'ãƒ´ã‚¡ã‚¤ã‚ªãƒªãƒ‹ã‚¹ãƒˆ', 'å½«åˆ»å¸«', 'ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰', 'ç ´è¼ª', 'æ¼å¸«', 'è‹äººå½¢å¸«', 'ã€Œæ‚ªå¤¢ã€', 'æ›¸è¨˜å®˜', 'éš è€…', 'å¤œã®ç•ªäºº', 'ã‚ªãƒšãƒ©æ­Œæ‰‹', 'ã€Œãƒ•ãƒ¼ãƒ«ã‚ºãƒ»ã‚´ãƒ¼ãƒ«ãƒ‰ã€', 'æ™‚ç©ºã®å½±', 'ã€Œè¶³èãˆã®ç¾Šã€', 'ã€Œãƒ•ãƒ©ãƒãƒ«ãƒ¼ã€', 'é›‘è²¨å•†', 'ã€Œãƒ“ãƒªãƒ¤ãƒ¼ãƒ‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€', 'ã€Œå¥³ç‹èœ‚ã€'];
    
    const MAPS = ['è»éœ€å·¥å ´', 'èµ¤ã®æ•™ä¼š', 'è–å¿ƒç—…é™¢', 'æ¹–æ™¯æ‘', 'æœˆã®æ²³å…¬åœ’', 'ãƒ¬ã‚ªã®æ€ã„å‡º', 'æ°¸çœ ç”º', 'ä¸­è¯è¡—', 'ç½ªã®æ£®'];
    
    const RANKS = ['1æ®µ', '2æ®µ', '3æ®µ', '4æ®µ', '5æ®µ', '6æ®µ', '7æ®µ', 'æœ€é«˜å³°'];
    
    let currentPerspective = 'survivor';
    let selectedEscapeCount = { survivor: null, hunter: null };
    let matches = [];
    let editingMatchId = null;
    
    // åˆæœŸåŒ–
    function init() {
      populateSelects();
      updateSurvivorSelects(); // ã‚µãƒã‚¤ãƒãƒ¼é¸æŠè‚¢ã®åˆæœŸåŒ–
      updateOpponentSurvivorSelects(); // ç›¸æ‰‹ã‚µãƒã‚¤ãƒãƒ¼é¸æŠè‚¢ã®åˆæœŸåŒ–
      loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
      updateAllWithFilters(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨çµ±è¨ˆã‚’æ›´æ–°
    }
    
    // ã‚µãƒã‚¤ãƒãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆé‡è¤‡ã‚’é™¤å¤–ï¼‰
    function updateSurvivorSelects() {
      const mySurvivor = document.getElementById('my-survivor').value;
      const teammate1 = document.getElementById('teammate-1').value;
      const teammate2 = document.getElementById('teammate-2').value;
      const teammate3 = document.getElementById('teammate-3').value;
      
      const selected = [mySurvivor, teammate1, teammate2, teammate3].filter(v => v);
      
      const selectIds = ['my-survivor', 'teammate-1', 'teammate-2', 'teammate-3'];
      
      selectIds.forEach(id => {
        const select = document.getElementById(id);
        const currentValue = select.value;
        
        // é¸æŠè‚¢ã‚’å†æ§‹ç¯‰
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        SURVIVORS.forEach(survivor => {
          // è‡ªåˆ†ãŒé¸æŠä¸­ã‹ã€ä»–ã§é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿è¡¨ç¤º
          if (survivor === currentValue || !selected.includes(survivor)) {
            const option = document.createElement('option');
            option.value = survivor;
            option.textContent = survivor;
            select.appendChild(option);
          }
        });
        
        // å€¤ã‚’å¾©å…ƒ
        select.value = currentValue;
      });
    }
    
    // ãƒãƒ³ã‚¿ãƒ¼è¦–ç‚¹ã®ç›¸æ‰‹ã‚µãƒã‚¤ãƒãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆé‡è¤‡ã‚’é™¤å¤–ï¼‰
    function updateOpponentSurvivorSelects() {
      const survivor1 = document.getElementById('opponent-survivor-1').value;
      const survivor2 = document.getElementById('opponent-survivor-2').value;
      const survivor3 = document.getElementById('opponent-survivor-3').value;
      const survivor4 = document.getElementById('opponent-survivor-4').value;
      
      const selected = [survivor1, survivor2, survivor3, survivor4].filter(v => v);
      
      const selectIds = ['opponent-survivor-1', 'opponent-survivor-2', 'opponent-survivor-3', 'opponent-survivor-4'];
      
      selectIds.forEach(id => {
        const select = document.getElementById(id);
        const currentValue = select.value;
        
        // é¸æŠè‚¢ã‚’å†æ§‹ç¯‰
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        SURVIVORS.forEach(survivor => {
          // è‡ªåˆ†ãŒé¸æŠä¸­ã‹ã€ä»–ã§é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿è¡¨ç¤º
          if (survivor === currentValue || !selected.includes(survivor)) {
            const option = document.createElement('option');
            option.value = survivor;
            option.textContent = survivor;
            select.appendChild(option);
          }
        });
        
        // å€¤ã‚’å¾©å…ƒ
        select.value = currentValue;
      });
    }
    
    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    function populateSelects() {
      const survivorSelects = ['my-survivor', 'teammate-1', 'teammate-2', 'teammate-3', 'opponent-survivor-1', 'opponent-survivor-2', 'opponent-survivor-3', 'opponent-survivor-4'];
      survivorSelects.forEach(id => {
        const select = document.getElementById(id);
        SURVIVORS.forEach(survivor => {
          const option = document.createElement('option');
          option.value = survivor;
          option.textContent = survivor;
          select.appendChild(option);
        });
      });
      
      const hunterSelects = ['my-hunter', 'opponent-hunter'];
      hunterSelects.forEach(id => {
        const select = document.getElementById(id);
        HUNTERS.forEach(hunter => {
          const option = document.createElement('option');
          option.value = hunter;
          option.textContent = hunter;
          select.appendChild(option);
        });
      });
      
      const mapSelects = ['survivor-map', 'hunter-map'];
      mapSelects.forEach(id => {
        const select = document.getElementById(id);
        MAPS.forEach(map => {
          const option = document.createElement('option');
          option.value = map;
          option.textContent = map;
          select.appendChild(option);
        });
      });
      
      const rankSelects = ['survivor-rank', 'hunter-rank'];
      rankSelects.forEach(id => {
        const select = document.getElementById(id);
        RANKS.forEach(rank => {
          const option = document.createElement('option');
          option.value = rank;
          option.textContent = rank;
          select.appendChild(option);
        });
      });
      
      // ã‚µãƒã‚¤ãƒãƒ¼é¸æŠæ™‚ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
      ['my-survivor', 'teammate-1', 'teammate-2', 'teammate-3'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => updateSurvivorSelectOptions());
      });
      
      // ãƒãƒ³ã‚¿ãƒ¼è¦–ç‚¹ã®ã‚µãƒã‚¤ãƒãƒ¼é¸æŠæ™‚ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
      ['opponent-survivor-1', 'opponent-survivor-2', 'opponent-survivor-3', 'opponent-survivor-4'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => updateHunterOpponentSelectOptions());
      });
    }
    
    // ã‚µãƒã‚¤ãƒãƒ¼è¦–ç‚¹ï¼šé¸æŠæ¸ˆã¿ã‚­ãƒ£ãƒ©ã‚’ä»–ã®é¸æŠè‚¢ã‹ã‚‰é™¤å¤–
    function updateSurvivorSelectOptions() {
      const mySurvivor = document.getElementById('my-survivor').value;
      const teammate1 = document.getElementById('teammate-1').value;
      const teammate2 = document.getElementById('teammate-2').value;
      const teammate3 = document.getElementById('teammate-3').value;
      
      const selected = [mySurvivor, teammate1, teammate2, teammate3].filter(v => v);
      
      ['my-survivor', 'teammate-1', 'teammate-2', 'teammate-3'].forEach(id => {
        const select = document.getElementById(id);
        const currentValue = select.value;
        
        // é¸æŠè‚¢ã‚’å†æ§‹ç¯‰
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        SURVIVORS.forEach(survivor => {
          // è‡ªåˆ†ä»¥å¤–ã§é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ£ãƒ©ã¯é™¤å¤–
          if (!selected.includes(survivor) || survivor === currentValue) {
            const option = document.createElement('option');
            option.value = survivor;
            option.textContent = survivor;
            select.appendChild(option);
          }
        });
        
        // ç¾åœ¨ã®å€¤ã‚’å¾©å…ƒ
        select.value = currentValue;
      });
    }
    
    // ãƒãƒ³ã‚¿ãƒ¼è¦–ç‚¹ï¼šé¸æŠæ¸ˆã¿ã‚­ãƒ£ãƒ©ã‚’ä»–ã®é¸æŠè‚¢ã‹ã‚‰é™¤å¤–
    function updateHunterOpponentSelectOptions() {
      const opponent1 = document.getElementById('opponent-survivor-1').value;
      const opponent2 = document.getElementById('opponent-survivor-2').value;
      const opponent3 = document.getElementById('opponent-survivor-3').value;
      const opponent4 = document.getElementById('opponent-survivor-4').value;
      
      const selected = [opponent1, opponent2, opponent3, opponent4].filter(v => v);
      
      ['opponent-survivor-1', 'opponent-survivor-2', 'opponent-survivor-3', 'opponent-survivor-4'].forEach(id => {
        const select = document.getElementById(id);
        const currentValue = select.value;
        
        // é¸æŠè‚¢ã‚’å†æ§‹ç¯‰
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        SURVIVORS.forEach(survivor => {
          // è‡ªåˆ†ä»¥å¤–ã§é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ£ãƒ©ã¯é™¤å¤–
          if (!selected.includes(survivor) || survivor === currentValue) {
            const option = document.createElement('option');
            option.value = survivor;
            option.textContent = survivor;
            select.appendChild(option);
          }
        });
        
        // ç¾åœ¨ã®å€¤ã‚’å¾©å…ƒ
        select.value = currentValue;
      });
    }
    
    // æ®µä½ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®šï¼ˆä½¿ç”¨æ¸ˆã¿æ®µä½ã®ã¿ï¼‰
    function populateRankFilters() {
      const perspectiveMatches = matches.filter(m => m.perspective === currentPerspective);
      const usedRanks = [...new Set(perspectiveMatches.map(m => m.rank).filter(r => r))];
      
      // RANKSé…åˆ—ã®é †åºã‚’ä¿æŒã—ã¦ã‚½ãƒ¼ãƒˆ
      const sortedRanks = RANKS.filter(rank => usedRanks.includes(rank));
      
      const filterIds = ['character-rank-filter', 'map-rank-filter', 'opponent-rank-filter', 'history-rank-filter'];
      filterIds.forEach(id => {
        const select = document.getElementById(id);
        const currentValue = select.value;
        select.innerHTML = '<option value="all">å…¨æ®µä½</option>';
        
        sortedRanks.forEach(rank => {
          const option = document.createElement('option');
          option.value = rank;
          option.textContent = rank;
          select.appendChild(option);
        });
        
        // å‰å›é¸æŠã—ã¦ã„ãŸå€¤ã‚’å¾©å…ƒ
        if (currentValue && (currentValue === 'all' || sortedRanks.includes(currentValue))) {
          select.value = currentValue;
        }
      });
      
      // ãƒãƒƒãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ç”¨ã€è‡ªã‚­ãƒ£ãƒ©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«é€£å‹•ï¼‰
      const myCharFilterValue = document.getElementById('my-char-filter')?.value || 'all';
      updateMapFilter(myCharFilterValue);
      
      // è‡ªã‚­ãƒ£ãƒ©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      updateMyCharFilter();
    }
    
    // ãƒãƒƒãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°ï¼ˆè‡ªã‚­ãƒ£ãƒ©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«é€£å‹•ï¼‰
    function updateMapFilter(selectedChar = 'all') {
      const perspectiveMatches = matches.filter(m => m.perspective === currentPerspective);
      
      // è‡ªã‚­ãƒ£ãƒ©ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      let filteredMatches = perspectiveMatches;
      if (selectedChar !== 'all') {
        filteredMatches = perspectiveMatches.filter(m => m.myCharacter === selectedChar);
      }
      
      const usedMaps = [...new Set(filteredMatches.map(m => m.map))].sort();
      
      const mapSelect = document.getElementById('opponent-map-filter');
      const currentValue = mapSelect.value;
      mapSelect.innerHTML = '<option value="all">å…¨ãƒãƒƒãƒ—</option>';
      usedMaps.forEach(map => {
        const option = document.createElement('option');
        option.value = map;
        option.textContent = map;
        mapSelect.appendChild(option);
      });
      
      // å‰å›é¸æŠã—ã¦ã„ãŸå€¤ã‚’å¾©å…ƒï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
      if (currentValue && (currentValue === 'all' || usedMaps.includes(currentValue))) {
        mapSelect.value = currentValue;
      }
    }
    
    // è‡ªã‚­ãƒ£ãƒ©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°ï¼ˆä½¿ç”¨æ¸ˆã¿ã‚­ãƒ£ãƒ©ã®ã¿ï¼‰
    function updateMyCharFilter() {
      const perspectiveMatches = matches.filter(m => m.perspective === currentPerspective);
      const usedChars = [...new Set(perspectiveMatches.map(m => m.myCharacter))].sort();
      
      // å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const opponentSelect = document.getElementById('my-char-filter');
      opponentSelect.innerHTML = '<option value="all">å…¨ã‚­ãƒ£ãƒ©</option>';
      usedChars.forEach(char => {
        const option = document.createElement('option');
        option.value = char;
        option.textContent = char;
        opponentSelect.appendChild(option);
      });
      
      // ãƒãƒƒãƒ—åˆ¥å‹ç‡ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const mapSelect = document.getElementById('map-char-filter');
      mapSelect.innerHTML = '<option value="all">å…¨ã‚­ãƒ£ãƒ©</option>';
      usedChars.forEach(char => {
        const option = document.createElement('option');
        option.value = char;
        option.textContent = char;
        mapSelect.appendChild(option);
      });
    }
    
    // è¦–ç‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
    function switchPerspective(perspective) {
      currentPerspective = perspective;
      
      document.querySelectorAll('.perspective-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      if (perspective === 'survivor') {
        document.getElementById('survivor-input').style.display = 'block';
        document.getElementById('hunter-input').style.display = 'none';
      } else {
        document.getElementById('survivor-input').style.display = 'none';
        document.getElementById('hunter-input').style.display = 'block';
      }
      
      updateAllWithFilters();
    }
    
    // ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
      document.querySelectorAll('.main-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + '-tab').classList.add('active');
      
      updateAllStats();
    }
    
    // è„±å‡ºäººæ•°ã‚’é¸æŠ
    function selectEscapeCount(perspective, count) {
      selectedEscapeCount[perspective] = count;
      
      const container = perspective === 'survivor' ? document.getElementById('survivor-input') : document.getElementById('hunter-input');
      container.querySelectorAll('.result-button').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
    }
    
    // è„±å‡ºäººæ•°ã‹ã‚‰å‹æ•—ã‚’åˆ¤å®š
    function getResultFromEscapeCount(escapeCount, perspective) {
      if (perspective === 'survivor') {
        if (escapeCount >= 3) return 'survivor_win';
        if (escapeCount === 2) return 'draw';
        return 'hunter_win';
      } else {
        if (escapeCount <= 1) return 'hunter_win';
        if (escapeCount === 2) return 'draw';
        return 'survivor_win';
      }
    }
    
    // è©¦åˆã‚’è¨˜éŒ²
    function submitMatch(perspective) {
      let match = {
        id: editingMatchId || Date.now(),
        perspective: perspective,
        timestamp: new Date().toISOString()
      };
      
      if (perspective === 'survivor') {
        const rank = document.getElementById('survivor-rank').value;
        const mySurvivor = document.getElementById('my-survivor').value;
        const teammate1 = document.getElementById('teammate-1').value;
        const teammate2 = document.getElementById('teammate-2').value;
        const teammate3 = document.getElementById('teammate-3').value;
        const opponentHunter = document.getElementById('opponent-hunter').value;
        const map = document.getElementById('survivor-map').value;
        const escapeCount = selectedEscapeCount.survivor;
        
        if (!rank || !mySurvivor || !teammate1 || !teammate2 || !teammate3 || !opponentHunter || !map || escapeCount === null) {
          alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        match.rank = rank;
        match.myCharacter = mySurvivor;
        match.teammates = [teammate1, teammate2, teammate3];
        match.opponentHunter = opponentHunter;
        match.map = map;
        match.escapeCount = escapeCount;
        match.result = getResultFromEscapeCount(escapeCount, perspective);
      } else {
        const rank = document.getElementById('hunter-rank').value;
        const myHunter = document.getElementById('my-hunter').value;
        const opponentSurvivor1 = document.getElementById('opponent-survivor-1').value;
        const opponentSurvivor2 = document.getElementById('opponent-survivor-2').value;
        const opponentSurvivor3 = document.getElementById('opponent-survivor-3').value;
        const opponentSurvivor4 = document.getElementById('opponent-survivor-4').value;
        const map = document.getElementById('hunter-map').value;
        const escapeCount = selectedEscapeCount.hunter;
        
        if (!rank || !myHunter || !opponentSurvivor1 || !opponentSurvivor2 || !opponentSurvivor3 || !opponentSurvivor4 || !map || escapeCount === null) {
          alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        match.rank = rank;
        match.myCharacter = myHunter;
        match.opponentSurvivors = [opponentSurvivor1, opponentSurvivor2, opponentSurvivor3, opponentSurvivor4];
        match.map = map;
        match.escapeCount = escapeCount;
        match.result = getResultFromEscapeCount(escapeCount, perspective);
      }
      
      if (editingMatchId) {
        matches = matches.filter(m => m.id !== editingMatchId);
        editingMatchId = null;
      }
      
      matches.push(match);
      saveData();
      
      // å‰å›ã®å…¥åŠ›å€¤ã‚’ä¿å­˜ï¼ˆæ®µä½ã¨è‡ªã‚­ãƒ£ãƒ©ã®ã¿ï¼‰
      saveLastInput(perspective, match.rank, match.myCharacter);
      
      resetForm(perspective);
      alert('è©¦åˆã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼');
      updateAllWithFilters();
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ®µä½ã¨è‡ªã‚­ãƒ£ãƒ©ã¯ä¿æŒï¼‰
    function resetForm(perspective) {
      if (perspective === 'survivor') {
        // æ®µä½ã¨è‡ªã‚­ãƒ£ãƒ©ã¯ä¿æŒ
        document.getElementById('teammate-1').value = '';
        document.getElementById('teammate-2').value = '';
        document.getElementById('teammate-3').value = '';
        document.getElementById('opponent-hunter').value = '';
        document.getElementById('survivor-map').value = '';
        selectedEscapeCount.survivor = null;
        document.querySelectorAll('#survivor-input .result-button').forEach(btn => {
          btn.classList.remove('selected');
        });
        updateSurvivorSelectOptions(); // é¸æŠè‚¢ã‚’æ›´æ–°
      } else {
        // æ®µä½ã¨è‡ªã‚­ãƒ£ãƒ©ã¯ä¿æŒ
        document.getElementById('opponent-survivor-1').value = '';
        document.getElementById('opponent-survivor-2').value = '';
        document.getElementById('opponent-survivor-3').value = '';
        document.getElementById('opponent-survivor-4').value = '';
        document.getElementById('hunter-map').value = '';
        selectedEscapeCount.hunter = null;
        document.querySelectorAll('#hunter-input .result-button').forEach(btn => {
          btn.classList.remove('selected');
        });
        updateHunterOpponentSelectOptions(); // é¸æŠè‚¢ã‚’æ›´æ–°
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    function saveData() {
      localStorage.setItem('identity5_matches', JSON.stringify(matches));
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    function loadData() {
      const saved = localStorage.getItem('identity5_matches');
      if (saved) {
        matches = JSON.parse(saved);
      }
      
      // å‰å›ã®å…¥åŠ›å€¤ã‚’å¾©å…ƒ
      const lastInputSurvivor = localStorage.getItem('identity5_last_input_survivor');
      if (lastInputSurvivor) {
        const data = JSON.parse(lastInputSurvivor);
        if (data.rank) document.getElementById('survivor-rank').value = data.rank;
        if (data.myCharacter) document.getElementById('my-survivor').value = data.myCharacter;
      }
      
      const lastInputHunter = localStorage.getItem('identity5_last_input_hunter');
      if (lastInputHunter) {
        const data = JSON.parse(lastInputHunter);
        if (data.rank) document.getElementById('hunter-rank').value = data.rank;
        if (data.myCharacter) document.getElementById('my-hunter').value = data.myCharacter;
      }
    }
    
    // å…¥åŠ›å€¤ã‚’ä¿å­˜
    function saveLastInput(perspective, rank, myCharacter) {
      const key = `identity5_last_input_${perspective}`;
      localStorage.setItem(key, JSON.stringify({ rank, myCharacter }));
    }
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    function getFilteredMatches(rankFilter) {
      let filtered = matches.filter(m => m.perspective === currentPerspective);
      if (rankFilter && rankFilter !== 'all') {
        filtered = filtered.filter(m => m.rank === rankFilter);
      }
      return filtered;
    }
    
    // è‡ªã‚­ãƒ£ãƒ©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´æ™‚ã®å‡¦ç†
    function onMyCharFilterChange() {
      const selectedChar = document.getElementById('my-char-filter').value;
      updateMapFilter(selectedChar);
      updateAllStats();
    }
    
    // å…¨ã¦ã®çµ±è¨ˆã‚’æ›´æ–°
    function updateAllStats() {
      updateOverallStats();
      updateCharacterStats();
      updateMapStats();
      updateOpponentStats();
      updateMatchHistory();
    }
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å«ã‚€å…¨ã¦ã‚’æ›´æ–°
    function updateAllWithFilters() {
      populateRankFilters();
      updateAllStats();
    }
    
    // å‹ç‡ã‚’è¨ˆç®—
    function calculateWinrate(matches, perspective) {
      const totalWithDraws = matches.length; // å¼•ãåˆ†ã‘ã‚’å«ã‚€ç·è©¦åˆæ•°
      const filtered = matches.filter(m => m.result !== 'draw');
      if (filtered.length === 0) return { wins: 0, losses: 0, draws: totalWithDraws, winrate: '0.0', total: 0, totalWithDraws: totalWithDraws };
      
      const wins = filtered.filter(m => {
        if (perspective === 'survivor') {
          return m.result === 'survivor_win';
        } else {
          return m.result === 'hunter_win';
        }
      }).length;
      
      const losses = filtered.length - wins;
      const draws = matches.filter(m => m.result === 'draw').length;
      const winrate = (wins / filtered.length * 100).toFixed(1);
      
      return { wins, losses, draws, winrate, total: filtered.length, totalWithDraws: totalWithDraws };
    }
    
    // é€£å‹æ•°ã‚’è¨ˆç®—
    function calculateWinStreak(matches, perspective) {
      if (matches.length === 0) return 0;
      
      // æœ€æ–°ã®è©¦åˆã‹ã‚‰é¡ã‚‹
      const sorted = [...matches].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      let streak = 0;
      
      for (const match of sorted) {
        if (match.result === 'draw') continue; // å¼•ãåˆ†ã‘ã¯ç„¡è¦–
        
        const isWin = (perspective === 'survivor' && match.result === 'survivor_win') || 
                      (perspective === 'hunter' && match.result === 'hunter_win');
        
        if (isWin) {
          streak++;
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    // å¹³å‡è„±å‡º/è„±è½äººæ•°ã‚’è¨ˆç®—
    function calculateAverageEscapeCount(matches, perspective) {
      if (matches.length === 0) return 0;
      
      const total = matches.reduce((sum, m) => sum + (m.escapeCount || 0), 0);
      return (total / matches.length).toFixed(1);
    }
    
    // ç·åˆå‹ç‡ã‚’æ›´æ–°ï¼ˆè©¦åˆå…¥åŠ›ã‚¿ãƒ–å†…ï¼‰
    function updateOverallStats() {
      const container = document.getElementById('overall-stats-inline');
      const perspectiveMatches = matches.filter(m => m.perspective === currentPerspective);
      
      if (perspectiveMatches.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      const stats = calculateWinrate(perspectiveMatches, currentPerspective);
      const streak = calculateWinStreak(perspectiveMatches, currentPerspective);
      
      let html = `<div class="stats-card" style="margin-bottom: 20px;">
        <div class="overall-stats-display">
          <div class="winrate-big">${stats.winrate}%</div>
          <div class="record-text">${stats.wins}å‹ ${stats.losses}æ•— ${stats.draws}åˆ†ã‘ (${stats.totalWithDraws}è©¦åˆ)</div>`;
      
      if (streak >= 2) {
        html += `<div class="streak-badge"><span class="streak-icon">ğŸ”¥</span>${streak}é€£å‹ä¸­ï¼</div>`;
      }
      
      html += `</div></div>`;
      container.innerHTML = html;
    }
    
    // è‡ªã‚­ãƒ£ãƒ©åˆ¥å‹ç‡ã‚’æ›´æ–°
    function updateCharacterStats() {
      const container = document.getElementById('character-stats');
      const rankFilter = document.getElementById('character-rank-filter').value;
      const perspectiveMatches = getFilteredMatches(rankFilter);
      
      if (perspectiveMatches.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>ã¾ã è©¦åˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }
      
      const characterStats = {};
      
      perspectiveMatches.forEach(match => {
        const char = match.myCharacter;
        if (!characterStats[char]) {
          characterStats[char] = [];
        }
        characterStats[char].push(match);
      });
      
      const sortedChars = Object.keys(characterStats).sort((a, b) => {
        const statsA = calculateWinrate(characterStats[a], currentPerspective);
        const statsB = calculateWinrate(characterStats[b], currentPerspective);
        
        // å‹ç‡ã§æ¯”è¼ƒ
        const winrateA = parseFloat(statsA.winrate);
        const winrateB = parseFloat(statsB.winrate);
        const winrateDiff = winrateB - winrateA;
        if (winrateDiff !== 0) return winrateDiff;
        
        // å‹ç‡ãŒåŒã˜ãªã‚‰å¹³å‡è„±å‡º/è„±è½äººæ•°ã§æ¯”è¼ƒ
        const avgEscapeA = parseFloat(calculateAverageEscapeCount(characterStats[a], currentPerspective));
        const avgEscapeB = parseFloat(calculateAverageEscapeCount(characterStats[b], currentPerspective));
        
        if (currentPerspective === 'survivor') {
          // ã‚µãƒã‚¤ãƒãƒ¼: å¹³å‡è„±å‡ºäººæ•°ãŒå¤šã„é †
          const avgDiff = avgEscapeB - avgEscapeA;
          if (Math.abs(avgDiff) > 0.01) return avgDiff;
        } else {
          // ãƒãƒ³ã‚¿ãƒ¼: å¹³å‡è„±è½äººæ•°ãŒå¤šã„é †ï¼ˆè„±è½ = 4 - è„±å‡ºï¼‰
          const avgFallA = 4 - avgEscapeA;
          const avgFallB = 4 - avgEscapeB;
          const avgDiff = avgFallB - avgFallA;
          if (Math.abs(avgDiff) > 0.01) return avgDiff;
        }
        
        // ãã‚Œã§ã‚‚åŒã˜ãªã‚‰è©¦åˆæ•°ã§æ¯”è¼ƒï¼ˆå¼•ãåˆ†ã‘å«ã‚€ï¼‰
        return statsB.totalWithDraws - statsA.totalWithDraws;
      });
      
      let html = `<div class="stats-card">
        <div class="stats-title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥å‹ç‡ï¼ˆ${currentPerspective === 'survivor' ? 'ã‚µãƒã‚¤ãƒãƒ¼' : 'ãƒãƒ³ã‚¿ãƒ¼'}ï¼‰</div>
        <div class="bar-chart-horizontal">`;
      
      sortedChars.forEach(char => {
        const stats = calculateWinrate(characterStats[char], currentPerspective);
        const avgEscape = calculateAverageEscapeCount(characterStats[char], currentPerspective);
        const winrateNum = parseFloat(stats.winrate) || 0;
        const barWidth = winrateNum;
        
        const avgText = currentPerspective === 'survivor' 
          ? `å¹³å‡è„±å‡º${avgEscape}äºº` 
          : `å¹³å‡è„±è½${(4 - parseFloat(avgEscape)).toFixed(1)}äºº`;
        
        const isZero = winrateNum === 0;
        
        html += `
          <div class="bar-row">
            <div class="bar-label-wrapper">
              <div class="bar-label">${char}</div>
              <div class="bar-sublabel">${avgText}<br>${stats.totalWithDraws}è©¦åˆ</div>
            </div>
            <div class="bar-wrapper">
              ${isZero ? `<div class="bar-value-zero">${stats.winrate}%</div>` : `
              <div class="bar-visual" style="width: ${barWidth}%;">
                <div class="bar-value">${stats.winrate}%</div>
              </div>`}
            </div>
          </div>
        `;
      });
      
      html += '</div></div>';
      container.innerHTML = html;
    }
    
    // ãƒãƒƒãƒ—åˆ¥å‹ç‡ã‚’æ›´æ–°
    function updateMapStats() {
      const container = document.getElementById('map-stats');
      const rankFilter = document.getElementById('map-rank-filter').value;
      const charFilter = document.getElementById('map-char-filter').value;
      let perspectiveMatches = getFilteredMatches(rankFilter);
      
      // è‡ªã‚­ãƒ£ãƒ©ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (charFilter !== 'all') {
        perspectiveMatches = perspectiveMatches.filter(m => m.myCharacter === charFilter);
      }
      
      if (perspectiveMatches.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>ã¾ã è©¦åˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }
      
      const mapStats = {};
      
      perspectiveMatches.forEach(match => {
        const map = match.map;
        if (!mapStats[map]) {
          mapStats[map] = [];
        }
        mapStats[map].push(match);
      });
      
      const sortedMaps = Object.keys(mapStats).sort((a, b) => {
        const statsA = calculateWinrate(mapStats[a], currentPerspective);
        const statsB = calculateWinrate(mapStats[b], currentPerspective);
        
        // å‹ç‡ã§æ¯”è¼ƒ
        const winrateDiff = parseFloat(statsB.winrate) - parseFloat(statsA.winrate);
        if (winrateDiff !== 0) return winrateDiff;
        
        // å‹ç‡ãŒåŒã˜ãªã‚‰è©¦åˆæ•°ã§æ¯”è¼ƒï¼ˆå¼•ãåˆ†ã‘å«ã‚€ï¼‰
        return statsB.totalWithDraws - statsA.totalWithDraws;
      });
      
      let html = `<div class="stats-card">
        <div class="stats-title">ãƒãƒƒãƒ—åˆ¥å‹ç‡</div>
        <div class="bar-chart-horizontal">`;
      
      sortedMaps.forEach(map => {
        const stats = calculateWinrate(mapStats[map], currentPerspective);
        const winrateNum = parseFloat(stats.winrate) || 0;
        const barWidth = winrateNum;
        const isZero = winrateNum === 0;
        
        html += `
          <div class="bar-row">
            <div class="bar-label-wrapper">
              <div class="bar-label">${map}</div>
              <div class="bar-sublabel">${stats.wins}å‹${stats.losses}æ•—${stats.draws}åˆ†</div>
            </div>
            <div class="bar-wrapper">
              ${isZero ? `<div class="bar-value-zero">${stats.winrate}%</div>` : `
              <div class="bar-visual" style="width: ${barWidth}%;">
                <div class="bar-value">${stats.winrate}%</div>
              </div>`}
            </div>
          </div>
        `;
      });
      
      html += '</div></div>';
      container.innerHTML = html;
    }
    
    // å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ã‚’æ›´æ–°
    function updateOpponentStats() {
      const container = document.getElementById('opponent-stats');
      const rankFilter = document.getElementById('opponent-rank-filter').value;
      const myCharFilter = document.getElementById('my-char-filter').value;
      const mapFilter = document.getElementById('opponent-map-filter').value;
      let perspectiveMatches = getFilteredMatches(rankFilter);
      
      // è‡ªã‚­ãƒ£ãƒ©ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (myCharFilter !== 'all') {
        perspectiveMatches = perspectiveMatches.filter(m => m.myCharacter === myCharFilter);
      }
      
      // ãƒãƒƒãƒ—ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (mapFilter !== 'all') {
        perspectiveMatches = perspectiveMatches.filter(m => m.map === mapFilter);
      }
      
      if (perspectiveMatches.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>ã¾ã è©¦åˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }
      
      if (currentPerspective === 'survivor') {
        const hunterStats = {};
        const teammateStats = {};
        
        perspectiveMatches.forEach(match => {
          const hunter = match.opponentHunter;
          if (!hunterStats[hunter]) {
            hunterStats[hunter] = [];
          }
          hunterStats[hunter].push(match);
          
          match.teammates.forEach(teammate => {
            if (!teammateStats[teammate]) {
              teammateStats[teammate] = [];
            }
            teammateStats[teammate].push(match);
          });
        });
        
        let html = `<div class="stats-card">
          <div class="stats-title">å¯¾æˆ¦ç›¸æ‰‹ãƒãƒ³ã‚¿ãƒ¼åˆ¥å‹ç‡</div>
          <div class="bar-chart-horizontal">`;
        
        Object.keys(hunterStats).sort((a, b) => {
          const statsA = calculateWinrate(hunterStats[a], currentPerspective);
          const statsB = calculateWinrate(hunterStats[b], currentPerspective);
          
          // å‹ç‡ã§æ¯”è¼ƒ
          const winrateDiff = parseFloat(statsB.winrate) - parseFloat(statsA.winrate);
          if (winrateDiff !== 0) return winrateDiff;
          
          // å‹ç‡ãŒåŒã˜ãªã‚‰è©¦åˆæ•°ã§æ¯”è¼ƒ
          return statsB.totalWithDraws - statsA.totalWithDraws;
        }).forEach(hunter => {
          const stats = calculateWinrate(hunterStats[hunter], currentPerspective);
          const winrateNum = parseFloat(stats.winrate) || 0;
          const barWidth = winrateNum;
          const isZero = winrateNum === 0;
          
          html += `
            <div class="bar-row">
              <div class="bar-label-wrapper">
                <div class="bar-label">${hunter}</div>
                <div class="bar-sublabel">${stats.wins}å‹${stats.losses}æ•—${stats.draws}åˆ†</div>
              </div>
              <div class="bar-wrapper">
                ${isZero ? `<div class="bar-value-zero">${stats.winrate}%</div>` : `
                <div class="bar-visual" style="width: ${barWidth}%;">
                  <div class="bar-value">${stats.winrate}%</div>
                </div>`}
              </div>
            </div>
          `;
        });
        
        html += `</div></div>
          <div class="stats-card">
            <div class="stats-title">å‘³æ–¹ç·¨æˆåˆ¥å‹ç‡</div>
            <div class="bar-chart-horizontal">`;
        
        Object.keys(teammateStats).sort((a, b) => {
          const statsA = calculateWinrate(teammateStats[a], currentPerspective);
          const statsB = calculateWinrate(teammateStats[b], currentPerspective);
          
          // å‹ç‡ã§æ¯”è¼ƒ
          const winrateDiff = parseFloat(statsB.winrate) - parseFloat(statsA.winrate);
          if (winrateDiff !== 0) return winrateDiff;
          
          // å‹ç‡ãŒåŒã˜ãªã‚‰è©¦åˆæ•°ã§æ¯”è¼ƒ
          return statsB.totalWithDraws - statsA.totalWithDraws;
        }).slice(0, 15).forEach(teammate => {
          const stats = calculateWinrate(teammateStats[teammate], currentPerspective);
          const winrateNum = parseFloat(stats.winrate) || 0;
          const barWidth = winrateNum;
          const isZero = winrateNum === 0;
          
          html += `
            <div class="bar-row">
              <div class="bar-label-wrapper">
                <div class="bar-label">${teammate}</div>
                <div class="bar-sublabel">${stats.wins}å‹${stats.losses}æ•—${stats.draws}åˆ†</div>
              </div>
              <div class="bar-wrapper">
                ${isZero ? `<div class="bar-value-zero">${stats.winrate}%</div>` : `
                <div class="bar-visual" style="width: ${barWidth}%;">
                  <div class="bar-value">${stats.winrate}%</div>
                </div>`}
              </div>
            </div>
          `;
        });
        
        html += '</div></div>';
        container.innerHTML = html;
        
      } else {
        const survivorStats = {};
        
        perspectiveMatches.forEach(match => {
          match.opponentSurvivors.forEach(survivor => {
            if (!survivorStats[survivor]) {
              survivorStats[survivor] = [];
            }
            survivorStats[survivor].push(match);
          });
        });
        
        let html = `<div class="stats-card">
          <div class="stats-title">å¯¾æˆ¦ç›¸æ‰‹ã‚µãƒã‚¤ãƒãƒ¼åˆ¥å‹ç‡</div>
          <div class="bar-chart-horizontal">`;
        
        Object.keys(survivorStats).sort((a, b) => {
          const statsA = calculateWinrate(survivorStats[a], currentPerspective);
          const statsB = calculateWinrate(survivorStats[b], currentPerspective);
          
          // å‹ç‡ã§æ¯”è¼ƒ
          const winrateDiff = parseFloat(statsB.winrate) - parseFloat(statsA.winrate);
          if (winrateDiff !== 0) return winrateDiff;
          
          // å‹ç‡ãŒåŒã˜ãªã‚‰è©¦åˆæ•°ã§æ¯”è¼ƒ
          return statsB.totalWithDraws - statsA.totalWithDraws;
        }).slice(0, 20).forEach(survivor => {
          const stats = calculateWinrate(survivorStats[survivor], currentPerspective);
          const winrateNum = parseFloat(stats.winrate) || 0;
          const barWidth = winrateNum;
          const isZero = winrateNum === 0;
          
          html += `
            <div class="bar-row">
              <div class="bar-label-wrapper">
                <div class="bar-label">${survivor}</div>
                <div class="bar-sublabel">${stats.wins}å‹${stats.losses}æ•—${stats.draws}åˆ†</div>
              </div>
              <div class="bar-wrapper">
                ${isZero ? `<div class="bar-value-zero">${stats.winrate}%</div>` : `
                <div class="bar-visual" style="width: ${barWidth}%;">
                  <div class="bar-value">${stats.winrate}%</div>
                </div>`}
              </div>
            </div>
          `;
        });
        
        html += '</div></div>';
        container.innerHTML = html;
      }
    }
    
    // è©¦åˆå±¥æ­´ã‚’æ›´æ–°
    function updateMatchHistory() {
      const container = document.getElementById('match-history');
      const rankFilter = document.getElementById('history-rank-filter').value;
      const perspectiveMatches = getFilteredMatches(rankFilter).reverse();
      
      if (perspectiveMatches.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>ã¾ã è©¦åˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }
      
      let html = '<div class="match-history">';
      
      perspectiveMatches.forEach(match => {
        const resultText = match.result === 'survivor_win' ? 'ã‚µãƒã‚¤ãƒãƒ¼å‹åˆ©' : match.result === 'hunter_win' ? 'ãƒãƒ³ã‚¿ãƒ¼å‹åˆ©' : 'å¼•ãåˆ†ã‘';
        const isWin = (currentPerspective === 'survivor' && match.result === 'survivor_win') || 
                      (currentPerspective === 'hunter' && match.result === 'hunter_win');
        const displayResultClass = isWin ? 'win' : match.result === 'draw' ? 'draw' : 'lose';
        const escapeInfo = match.escapeCount !== undefined ? ` (è„±å‡º${match.escapeCount}äºº)` : '';
        const rankInfo = match.rank ? `[${match.rank}] ` : '';
        
        let details = '';
        if (match.perspective === 'survivor') {
          details = `${rankInfo}${match.myCharacter} + ${match.teammates.join(', ')} vs ${match.opponentHunter} @ ${match.map}${escapeInfo}`;
        } else {
          details = `${rankInfo}${match.myCharacter} vs ${match.opponentSurvivors.join(', ')} @ ${match.map}${escapeInfo}`;
        }
        
        html += `
          <div class="match-item">
            <div class="match-info">
              <span class="match-result ${displayResultClass}">${resultText}</span>
              <span>${details}</span>
            </div>
            <div class="match-actions">
              <button class="edit-button" onclick="editMatch(${match.id})">ç·¨é›†</button>
              <button class="delete-button" onclick="deleteMatch(${match.id})">å‰Šé™¤</button>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // è©¦åˆã‚’ç·¨é›†
    function editMatch(id) {
      const match = matches.find(m => m.id === id);
      if (!match) return;
      
      editingMatchId = id;
      
      if (match.perspective === 'survivor') {
        currentPerspective = 'survivor';
        document.getElementById('survivor-rank').value = match.rank || '';
        document.getElementById('my-survivor').value = match.myCharacter;
        document.getElementById('teammate-1').value = match.teammates[0];
        document.getElementById('teammate-2').value = match.teammates[1];
        document.getElementById('teammate-3').value = match.teammates[2];
        document.getElementById('opponent-hunter').value = match.opponentHunter;
        document.getElementById('survivor-map').value = match.map;
        selectedEscapeCount.survivor = match.escapeCount !== undefined ? match.escapeCount : null;
        
        document.querySelectorAll('.perspective-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.perspective-tab')[0].classList.add('active');
        document.getElementById('survivor-input').style.display = 'block';
        document.getElementById('hunter-input').style.display = 'none';
        
        updateSurvivorSelects(); // é¸æŠè‚¢ã‚’æ›´æ–°
        
        document.querySelectorAll('#survivor-input .result-button').forEach((btn, index) => {
          btn.classList.remove('selected');
          if (match.escapeCount !== undefined && index === match.escapeCount) {
            btn.classList.add('selected');
          }
        });
        
        // é¸æŠè‚¢ã‚’æ›´æ–°
        updateSurvivorSelectOptions();
      } else {
        currentPerspective = 'hunter';
        document.getElementById('hunter-rank').value = match.rank || '';
        document.getElementById('my-hunter').value = match.myCharacter;
        document.getElementById('opponent-survivor-1').value = match.opponentSurvivors[0];
        document.getElementById('opponent-survivor-2').value = match.opponentSurvivors[1];
        document.getElementById('opponent-survivor-3').value = match.opponentSurvivors[2];
        document.getElementById('opponent-survivor-4').value = match.opponentSurvivors[3];
        document.getElementById('hunter-map').value = match.map;
        selectedEscapeCount.hunter = match.escapeCount !== undefined ? match.escapeCount : null;
        
        document.querySelectorAll('.perspective-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.perspective-tab')[1].classList.add('active');
        document.getElementById('survivor-input').style.display = 'none';
        document.getElementById('hunter-input').style.display = 'block';
        
        updateHunterOpponentSelectOptions(); // é¸æŠè‚¢ã‚’æ›´æ–°
        
        document.querySelectorAll('#hunter-input .result-button').forEach((btn, index) => {
          btn.classList.remove('selected');
          if (match.escapeCount !== undefined && index === match.escapeCount) {
            btn.classList.add('selected');
          }
        });
      }
      
      document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.main-tab')[0].classList.add('active');
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById('input-tab').classList.add('active');
      
      window.scrollTo(0, 0);
    }
    
    // è©¦åˆã‚’å‰Šé™¤
    function deleteMatch(id) {
      if (!confirm('ã“ã®è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      matches = matches.filter(m => m.id !== id);
      saveData();
      updateAllWithFilters();
      alert('è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }
    
    // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetAllData() {
      if (!confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
      
      matches = [];
      saveData();
      updateAllWithFilters();
      alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    }
    
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
